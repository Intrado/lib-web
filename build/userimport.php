<?
/*
Author: Ben Hencke

reads from input file and creates users.

valid header fields:
login,password,accesscode,pin,firstname,lastname,phone,callerid,email,profile,f01,...,f20

if an F field is specified, it is used to create a rule for the user.
if a profile doesn't exist, it will be created, but without any permissions.
*/


if ($argc < 2)
	exit("Please specify an input file");

$inputfile = $argv[1];

$SETTINGS = parse_ini_file("../inc/settings.ini.php",true);
$IS_COMMSUITE = $SETTINGS['feature']['is_commsuite'];

require_once("../inc/db.inc.php");
require_once("../inc/DBMappedObject.php");
require_once("../inc/DBRelationMap.php");
require_once("../obj/User.obj.php");
require_once("../obj/UserRule.obj.php");
require_once("../obj/Access.obj.php");
require_once("../obj/Person.obj.php");
require_once("../obj/Permission.obj.php");
require_once("../obj/Rule.obj.php");


$fp = fopen($inputfile,"r") or exit("Can't open input file");
//get header row for field mappings

$header = fgetcsv($fp) or exit("Can't read header row");
$header = array_flip($header);

$line = 1;
while($row = fgetcsv($fp)) {
	$line++;

	//ignore blank lines
	if (count($row) == 1)
		continue;

	//warn on incomplete lines
	if (count($row) != count($header)) {
		echo "Wrong col count on line $line, was expecting" . count($header) . ", ignoring line\n";
		continue;
	}

	if (!isset($row[$header['login']]) || trim($row[$header['login']]) == "") {
		echo "Missing login, required for import line:$line\n";
		continue;
	}

	$login = trim($header['login']);

	$user = DBFind("User","from user where login='" . DBSafe($login) . "' and deleted=0 where customerid=1");
	if (!$user) {
		$user = new User();
		$user->customerid=1;
		$user->login = $login;
		$user->accesscode = "";
		$user->create() or exit(mysql_error());
	}

	foreach (array("accesscode","firstname","lastname","phone","email") as $name) {
		if (isset($header[$name]))
			$user->$name = trim($row[$header[$name]]);
	}

	if (isset($header["profile"])) {
		$name = trim($row[$header["profile"]]);

		$profile = DBFind("Access","from access where name='" . DBSafe($name) . "' and customerid=1");
		if (!$profile) {
			$profile = new Access();
			$profile->name = $name;
			$profile->description = "Generated by userimport.php";
			$profile->customerid = 1;
			$profile->created = QuickQuery("select now()");
			$profile->create() or exit(mysql_error());
		}

		$user->accessid = $profile->id;
	}

	if (isset($header["password"]))
		$user->setPassword(trim($row[$header["password"]]));

	if (isset($header["pin"]))
		$user->setPincode(trim($row[$header["pin"]]));

	if (isset($header["callerid"])) {
		$callerid = Phone::parse($row[$header["pin"]]);
		if (strlen($callerid) != 10)
			echo "Invaid callerid line $line";
		else
			$user->setSetting("callerid",$callerid);
	}

	$newrules = array();
	$hasrules = false;
	foreach ($header as $name) {
		if (ereg("^(f[0-9]{2})$",$name,$args)) {
			$hasrules = true;
			$rule = new Rule();
			$rule->logical = "and";
			$rule->fieldnum = $args[1];
			$rule->op = "in";
			$rule->val = trim($row[$header[$name]]);
			$newrules[] = $rule;
		}
	}

	if ($hasrules) {
		QuickUpdate("delete from rule where id in (select ruleid from userrule where userid=$user->id)");
		QuickUpdate("delete from userrule where userid=$user->id");
		//make new ones
		foreach ($newrules as $rule) {
			$rule->create();
			$userrule = new UserRule();
			$userrule->userid = $user->id;
			$userrule->ruleid = $rule->id;
			$userrule->create();
		}
	}
}