<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- non framed -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Message Sender (SchoolMessenger)</title>
~[wc:commonscripts]
<link href="/images/css/screen.css" rel="stylesheet" media="screen">
<link href="/images/css/print.css" rel="stylesheet" media="print">
<script type="text/javascript">
	// add student and staff staff selections to pkeyList (if any are selected)
	var pkeyList = [
~[tlist_sql; SELECT s.Student_Number from ~[temp.table.current.selection:students] t inner join Students s on (s.dcid = t.dcid)]"~(1)",[/tlist_sql]
~[tlist_sql; SELECT s.TeacherNumber from ~[temp.table.current.selection:teachers] t inner join Teachers s on (s.dcid = t.dcid)]"~(1)",[/tlist_sql]];
	var plugins = [~[tlist_sql; SELECT distinct pd.Name, pl.ID, pr.RegistrationURL  
from PluginDef pd 
inner join PluginDefInterfaceMap pdi on (pdi.PluginDefID = pd.ID)
inner join PluginLink pl on (pl.PluginDefInterfaceMapID = pdi.ID)
inner join PluginLinkContext plc on (plc.PluginLinkID = pl.ID)
inner join PluginRegistration pr on (pr.ID = pd.PluginRegistrationID)
where pd.Name like '%SchoolMessenger%' and plc.Location like 'admin.%' and pd.IsEnabled = 1
and exists (select 1 from PluginConfigOIDProvider pco where pco.PluginDefID = pd.ID)
order by 2 ASC]
{"ssoLink": "/admin/openid/oidredirectaction.action?pluginName=~(1)&linkId=~(2)",
 "registrationUrl": "~(3)",
 "name": "~(1)"},
[/tlist_sql]];
</script>
</head>
<body>
	~[wc:admin_header_css]
	<!-- breadcrumb start -->
	<a href="/admin/home.html" target="_top">Start&nbsp;Page</a>&nbsp;&gt;&nbsp;
	<a href="/admin/functions.html" target="_top">Special&nbsp;Functions</a>&nbsp;&gt;&nbsp;
	Message&nbsp;Sender
	<!-- breadcrumb end -->
	
	~[wc:admin_navigation_css]
	
	<!-- Message Sender content and any messages for the user will get displayed here -->
	<div id="content-msgsndr">
		<h1>Loading...</h1>
	</div>
	
	~[wc:admin_footer_css]

	<!-- load external js files at the end of the document -->
	<script type="text/javascript">
		plugin = false;
		(function($){
			// TODO: no registrationUrl set? Display an error
			// detect multiple plugins and present the user with a choice of which to use
			if (plugins.length > 1) {
				var container = $("#content-msgsndr");
				container.html(
						'<div id="selectplugin">' +
							'<h1>New Broadcast</h1>' +
							'<div class="box-round">' +
								'<h2>Select a plugin</h2>' +
								'<ul class="plugins">' +
								'</ul>' +
							'</div>' +
						'</div>'
				);
				$.each(plugins, function(id, data) {
					var li = $("<li><a href='#'>" + data.name + "</a></li>");
					container.find("ul").append(li);
					li.on("click", function(event) {
						event.preventDefault();
						getApp(data);
					})
				})
			} else {
				getApp(plugins[0]);
			}
		})(jQuery);

		function getApp(selectedPlugin) {
			plugin = selectedPlugin;
			// pull the application from the plugin registration url
			var remoteAppUrl = selectedPlugin.registrationUrl.replace(/\/api\/.*$/g, "") + "/script/powerschool/msgsndr_embedded.js";
			jQuery.getScript(remoteAppUrl);
		}
	</script>

</body>
</html><!-- non framed -->
